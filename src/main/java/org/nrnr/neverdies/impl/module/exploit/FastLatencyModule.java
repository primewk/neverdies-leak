package org.nrnr.neverdies.impl.module.exploit;

import net.minecraft.network.packet.c2s.play.RequestCommandCompletionsC2SPacket;
import net.minecraft.network.packet.s2c.play.CommandSuggestionsS2CPacket;
import org.nrnr.neverdies.api.event.listener.EventListener;
import org.nrnr.neverdies.api.module.ModuleCategory;
import org.nrnr.neverdies.api.module.ToggleModule;
import org.nrnr.neverdies.impl.event.TickEvent;
import org.nrnr.neverdies.impl.event.network.DisconnectEvent;
import org.nrnr.neverdies.impl.event.network.PacketEvent;
import org.nrnr.neverdies.init.Managers;
import org.nrnr.neverdies.util.math.timer.CacheTimer;
import org.nrnr.neverdies.util.math.timer.Timer;

public class FastLatencyModule extends ToggleModule {

    private long requestTime;
    private long latency;
    private final Timer lastRequest = new CacheTimer();
    private final Timer requestTimer = new CacheTimer();

    public FastLatencyModule() {
        super("FastLatency", "Calculates server ping", ModuleCategory.EXPLOITS);
    }

    @Override
    public String getModuleData() {
        return String.format("%dms", latency);
    }

    @EventListener
    public void onDisconnect(DisconnectEvent event) {
        latency = 0;
        requestTime = 0;
    }

    @EventListener
    public void onTick(TickEvent event) {
        if (lastRequest.passed(5000) && requestTimer.passed(500)) {
            Managers.NETWORK.sendPacket(new RequestCommandCompletionsC2SPacket(1000, "w "));
            requestTimer.reset();
            lastRequest.reset();
            requestTime = System.currentTimeMillis();
        }
    }

    @EventListener
    public void onPacketInbound(PacketEvent.Inbound event) {
        if (event.getPacket() instanceof CommandSuggestionsS2CPacket packet && packet.getCompletionId() == 1000) {
            latency = System.currentTimeMillis() - requestTime;
            lastRequest.setElapsedTime(Timer.MAX_TIME);
        }
    }

    public long getLatency() {
        return latency;
    }
}
